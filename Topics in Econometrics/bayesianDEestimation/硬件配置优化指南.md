# 硬件配置优化指南 (i9-13905H)

## 您的硬件配置

**CPU:** Intel i9-13905H
- 14核心（6个P核 + 8个E核）
- 20线程
- 基础频率: 2.6 GHz，最高频率: 5.4 GHz

**内存:** 32GB DDR5

**GPU:** RTX 4060 Laptop (60W TGP)

**存储:** 1TB NVMe SSD

## 优化配置

### 1. Julia线程配置 ✅ 已配置

您已设置 `JULIA_NUM_THREADS=12`，这是**最优配置**：

**原理:**
- 12线程占用大部分计算资源（60%）
- 为R并行预留剩余线程
- 避免超线程竞争（20线程总容量）

**验证配置:**
```bash
# 命令行检查
echo %JULIA_NUM_THREADS%
# 应显示: 12

# 或在Julia中验证
julia -e "println(Threads.nthreads())"
# 应显示: 12
```

### 2. R并行配置 ✅ 自动优化

代码会自动使用 **18个并行工作核心**：

```r
# 01_setup_environment.R 会自动检测
n_cores_total <- 20  # 自动检测
n_cores_use <- 18    # 保留2个给系统
```

**并行策略:**
- **Phase 5 递归预测:** 18个工作进程同时运行
- **每个工作进程:** 处理约13个预测点（230 ÷ 18 ≈ 13）
- **预期加速比:** 15-17倍（考虑开销）

### 3. 运行时间预估（针对您的硬件）

**单个BVAR估计耗时:** ~12-18秒
- P核处理主计算
- E核处理后台任务

**Phase 5总耗时:**
- 230个预测点 × 3个模型 = 690次估计
- 顺序执行: 690 × 15秒 ≈ 2.9小时
- **18核并行: 2.9小时 ÷ 17 ≈ 10-12分钟/模型**
- **总计: 30-40分钟**（含初始化和检查点保存）

### 4. 性能监控

**运行Phase 5时应该看到:**

1. **任务管理器 (Ctrl+Shift+Esc):**
   - 18个 `Rscript.exe` 进程
   - CPU使用率: 85-95%（接近满载）
   - P核使用率: ~95%
   - E核使用率: ~80%

2. **内存使用:**
   - 每个R进程: ~500MB-1GB
   - 总内存占用: ~12-18GB（32GB内存足够）
   - Julia进程: ~2-3GB

3. **温度:**
   - CPU: 75-90°C（正常）
   - GPU: 闲置（~40°C，本研究不使用GPU）

### 5. 进一步优化建议

#### 临时性能提升（运行Phase 5前）

```powershell
# PowerShell管理员模式运行

# 1. 设置高性能电源计划
powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c

# 2. 禁用CPU节能（可选）
powercfg /change standby-timeout-ac 0
powercfg /change monitor-timeout-ac 0

# 3. 提高R进程优先级（可选，需管理员权限）
# 在任务管理器中右键Rscript.exe → 设置优先级 → 高于正常
```

#### 散热优化

```bash
# 如果CPU温度持续>90°C，考虑：
# 1. 使用笔记本散热垫
# 2. 调整性能模式（平衡模式 vs 性能模式）
# 3. 清理散热通道
```

### 6. 基准测试

**Phase 4测试估计** 会给出单次BVAR估计的准确耗时：

预期输出类似：
```
✓ Estimation successful!
  Elapsed time: 14.2 seconds

Optimal hyperparameters:
  Lambda: 0.1234
  Alpha: 2.0000
```

**根据测试结果调整预期:**
- 如果单次估计 < 12秒: Phase 5可能只需25-30分钟
- 如果单次估计 > 20秒: Phase 5可能需要45-55分钟

### 7. 故障排除

#### 只看到1个R进程（并行失败）

```r
# 检查并行配置
getOption("bayesian_de.n_cores")
# 应返回: 18

# 手动设置
options(bayesian_de.n_cores = 18)

# 重新运行Phase 5
```

#### CPU使用率低于50%

**可能原因:**
1. 杀毒软件实时扫描干扰
2. 磁盘I/O瓶颈（检查SSD健康状态）
3. Windows后台更新

**解决:**
```powershell
# 临时禁用Windows Defender（管理员模式）
Set-MpPreference -DisableRealtimeMonitoring $true

# 运行完成后重新启用
Set-MpPreference -DisableRealtimeMonitoring $false
```

#### 内存不足（不太可能发生）

```r
# 如果32GB内存仍不够（极少发生）
# 减少MCMC采样数
# 编辑 code/05_recursive_forecasting.R 第14-15行:
n_draw = 5000   # 从10000减半
n_burn = 2500   # 从5000减半
```

### 8. 理想运行环境

**最佳实践:**
- ✅ 连接电源（避免电池模式降频）
- ✅ 关闭不必要的应用（Chrome、IDE等）
- ✅ 性能模式（不是省电模式）
- ✅ 良好散热（散热垫、通风环境）
- ✅ 晚上/周末运行（无人干扰）

**避免:**
- ❌ 电池模式运行（CPU会降频到~15W）
- ❌ 同时运行其他大型程序
- ❌ 温度超过95°C（会自动降频）

### 9. 性能对比

**您的配置 vs 计划中的估算:**

| 指标 | 初始计划 | 您的实际配置 |
|------|---------|-------------|
| CPU线程 | 28（假设） | 20 |
| R并行核心 | 26 | 18 |
| Julia线程 | 14（假设） | 12 |
| 预期加速比 | 15-20× | 15-17× |
| Phase 5耗时 | 12-20分钟/模型 | 10-15分钟/模型 |
| **总耗时** | **35-60分钟** | **30-45分钟** ✅ |

**结论:** 您的硬件配置完全满足要求，预计总运行时间在舒适范围内！

---

## 快速验证脚本

运行此脚本检查配置是否正确：

```r
# check_config.R
cat("=== 硬件配置检查 ===\n\n")

# R并行
cat("R配置:\n")
cat(sprintf("  Total cores: %d\n", parallel::detectCores()))
cat(sprintf("  Parallel workers: %d\n", 
            getOption("bayesian_de.n_cores", detectCores() - 2)))

# Julia
library(JuliaCall)
julia_setup()
cat("\nJulia配置:\n")
cat(sprintf("  Version: %s\n", julia_eval("string(VERSION)")))
cat(sprintf("  Threads: %d\n", julia_eval("Threads.nthreads()")))

# 内存
cat("\nR内存:\n")
cat(sprintf("  Available: %.1f GB\n", 
            as.numeric(memory.size(max = TRUE)) / 1024))

cat("\n✓ 配置检查完成\n")
```

预期输出：
```
=== 硬件配置检查 ===

R配置:
  Total cores: 20
  Parallel workers: 18

Julia配置:
  Version: 1.10.0
  Threads: 12

R内存:
  Available: 32.0 GB

✓ 配置检查完成
```
