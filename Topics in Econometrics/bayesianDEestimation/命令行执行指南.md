# 命令行执行指南 (Command Line Guide)

## 快速开始 (Quick Start)

### 1. 首次安装依赖

```bash
# 打开项目目录
cd "e:\IHEID Economics\IHEID\Topics in Econometrics\bayesianDEestimation"

# 初始化Julia环境
julia --project=julia -e 'using Pkg; Pkg.instantiate()'

# 初始化R环境（在R中运行）
Rscript -e "install.packages('renv'); renv::init()"
```

### 2. 设置FRED API密钥

**Windows命令提示符:**
```cmd
setx FRED_API_KEY "你的API密钥"
```

**PowerShell:**
```powershell
[Environment]::SetEnvironmentVariable("FRED_API_KEY", "你的API密钥", "User")
```

重启命令行窗口使环境变量生效。

### 3. 完整运行分析流程

**方式1: 一键运行所有阶段**
```bash
Rscript main_analysis.R
```

**方式2: 分阶段运行（推荐用于调试）**
```bash
# Phase 1: 环境设置（2分钟）
Rscript code/01_setup_environment.R

# Phase 2: 数据获取（5分钟）
Rscript code/02_data_acquisition.R

# Phase 3: 数据转换（1分钟）
Rscript code/03_data_transformation.R

# Phase 4: BVAR测试估计（3分钟）
Rscript code/04_bvar_estimation.R

# Phase 5: 递归预测（⚠ 35-60分钟）
Rscript code/05_recursive_forecasting.R

# Phase 6: 预测评估（5分钟）
Rscript code/06_forecast_evaluation.R

# Phase 7: CG回归（3分钟）
Rscript code/07_cg_regression.R

# Phase 8: 可视化（2分钟）
Rscript code/08_visualization.R

## 详细步骤说明

### Phase 1: 环境设置

**命令:**
```bash
cd "e:\IHEID Economics\IHEID\Topics in Econometrics\bayesianDEestimation"
Rscript code/01_setup_environment.R
```

**预期输出:**
```
=== Initializing R-Julia Hybrid Environment ===

Step 1: Loading R packages...
✓ All R packages loaded successfully.

Step 2: Initializing Julia via JuliaCall...
✓ Julia initialized successfully.
  Julia version: 1.10.0
  Julia threads: 14 (physical cores)

Step 3: Setting up Julia packages...
✓ Julia packages loaded successfully.

Step 4: Loading Julia transformation functions...
✓ Loaded julia/transformation_functions.jl

Step 5: Configuring R parallel computing...
  Total cores: 28
  Cores for parallel: 26

Step 6: Verifying directory structure...
✓ Directory structure verified.

=== Environment Setup Complete ===
```

**如果遇到错误:**
- Julia未找到: 设置 `JULIA_HOME` 环境变量
- 包安装失败: 检查网络连接，重试安装

### Phase 2: 数据获取

**命令:**
```bash
Rscript code/02_data_acquisition.R
```

**首次运行会提示输入API密钥**

**预期输出:**
```
=== Starting Data Acquisition ===

Step 1: Setting up FRED API connection...
✓ FRED API configured.

Step 2: Defining variable lists...
  Small model: 4 variables
  Medium model: 6 variables
  Full model: 7 variables

Step 3: Downloading data from FRED (1985-01-01 to 2019-12-31)...
  ✓ Downloaded INDPRO (420 observations)
  ✓ Downloaded CPIAUCSL (420 observations)
  ...

Step 4: Merging and cleaning data...
✓ Clean dataset: 420 observations × 7 variables

Step 5: Creating three nested datasets...
✓ Data acquisition complete!
```

### Phase 3: 数据转换

**命令:**
```bash
Rscript code/03_data_transformation.R
```

**预期输出:**
```
=== Starting Data Transformation ===

Step 1: Loading raw data...
Step 2: Applying transformations for BVAR estimation...
  INDPRO: log transformation
  CPIAUCSL: log transformation
  ...

Step 4: Computing evaluation transforms using Julia...
✓ Julia transformation functions loaded successfully.
  ✓ Evaluation transforms computed.

✓ Data transformation complete!
```

### Phase 4: BVAR测试估计

**命令:**
```bash
Rscript code/04_bvar_estimation.R
```

**预期输出:**
```
=== Hierarchical BVAR Estimation Setup ===

Step 4: Testing BVAR estimation on full sample...
✓ Estimation successful!

Step 5: Optimal hyperparameters from test estimation:

Minnesota Prior:
  Lambda (tightness): 0.1234
  Alpha (lag decay): 2.0000

Log-marginal likelihood: -1234.56

✓ BVAR Estimation Setup Complete
```

### Phase 5: 递归预测（⚠ 最耗时）

**命令:**
```bash
Rscript code/05_recursive_forecasting.R
```

**重要提示:**
- 预计运行时间: 35-60分钟
- 确保电脑不会进入睡眠/休眠
- 每50个预测点会自动保存检查点

**预期输出:**
```
=== Starting Recursive Forecasting (Parallelized) ===

⚠ This will take approximately 35-60 minutes.
  Progress will be saved with checkpoints every 50 origins.

Step 4: Initializing parallel cluster...
  Cluster created with 26 workers.
  ✓ Cluster initialized.

═══ Forecasting SMALL Model ═══
  Variables: 4
  Forecast origins: 230
  Using 26 parallel workers

  Starting parallel forecasting...
  Progress:
    Batch 1/5: Origins 1-50... Done.
      [Checkpoint saved: 50/230 origins]
    Batch 2/5: Origins 51-100... Done.
      [Checkpoint saved: 100/230 origins]
    ...

  ✓ SMALL model complete in 15.3 minutes
  Average time per origin: 4.0 seconds

[Medium和Full模型类似...]

═══════════════════════════════════════════════════
  RECURSIVE FORECASTING COMPLETE
═══════════════════════════════════════════════════
```

**如果中断:**
- 重新运行脚本
- 系统会检测到检查点文件
- 提示是否从上次中断处继续

### Phase 6: 预测评估

**命令:**
```bash
Rscript code/06_forecast_evaluation.R
```

**预期输出:**
```
=== Forecast Evaluation ===

RMSFE Results (Small Model):
  model variable    h1    h3   h12
  Small      CPI 1.234 1.456 1.678
  Small   INDPRO 2.345 2.567 2.789

Relative RMSFE (< 1 = Better than RW):
  model variable rel_h1 rel_h3 rel_h12
  Small      CPI  0.890  0.923   0.956
  Small   INDPRO  0.856  0.887   0.912

✓ Forecast evaluation complete!
```

### Phase 7: CG回归

**命令:**
```bash
Rscript code/07_cg_regression.R
```

**预期输出:**
```
=== Coibion-Gorodnichenko Regression Analysis ===

═══ CG Regression Results (Small Model, CPI) ═══

horizon    beta      se  t_stat p_value n_obs
    h=1  0.1234  0.0567   2.178   0.030   228
    h=3  0.0987  0.0623   1.584   0.114   226
   h=12 -0.0456  0.0789  -0.578   0.563   218

Interpretation:
h=1:
  β = 0.1234 (SE = 0.0567)
  95% CI: [0.0123, 0.2345]
  → β > 0: Under-reaction to news (sticky information)

✓ CG regression analysis complete!
```

## 监控和调试

### 查看实时进度

**检查checkpoint文件:**
```bash
dir results\forecasts\checkpoints
```

**查看已生成文件:**
```bash
dir results\forecasts
dir results\tables
```

### 查看日志

```bash
# 查看最新日志
type results\analysis_log_*.txt
```

### 查看内存使用

**在R中运行:**
```r
# 查看对象大小
object.size(data_small_est)

# 垃圾回收
gc()
```

## 性能优化建议

### 1. 临时禁用Windows Defender实时扫描

Phase 5运行期间，大量文件读写会触发实时扫描。

**步骤:**
1. Windows安全中心 → 病毒和威胁防护
2. 管理设置 → 关闭"实时保护"
3. 运行完Phase 5后重新开启

### 2. 设置高性能电源计划

```cmd
powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
```

### 3. 增加R内存限制

```r
# 在脚本开头添加
memory.limit(size = 30000)  # 设置为30GB
```

### 4. 监控CPU使用率

**任务管理器 (Ctrl+Shift+Esc):**
- 应该看到26个R进程同时运行
- CPU使用率应接近100%

## 常见问题

### Q1: "Error: Julia not found"

**解决:**
```bash
# 查找Julia安装路径
where julia

# 设置环境变量（替换为你的实际路径）
setx JULIA_HOME "C:\Users\YourName\AppData\Local\Programs\Julia-1.10.0\bin"
```

### Q2: "Error: FRED_API_KEY not set"

**解决:**
```bash
# 注册API密钥: https://fred.stlouisfed.org/docs/api/api_key.html
setx FRED_API_KEY "your_actual_key_here"

# 重启命令行窗口
```

### Q3: Phase 5运行很慢

**检查:**
- 任务管理器中R进程数量（应该有26个）
- CPU使用率（应该接近100%）
- 磁盘活动（如果持续高IOPS，可能是杀毒软件干扰）

**优化:**
```r
# 减少核心数（如果不稳定）
options(bayesian_de.n_cores = 12)
```

### Q4: 内存不足

**解决:**
- 关闭其他程序
- 减少MCMC抽样数:
  ```r
  # 编辑 code/05_recursive_forecasting.R
  # 改为: n_draw = 5000, n_burn = 2500
  ```

## 验证安装

运行此脚本验证所有依赖已正确安装:

```bash
Rscript -e "
required_pkgs <- c('BVAR', 'tidyverse', 'JuliaCall', 'fredr', 'xts', 
                   'sandwich', 'lmtest', 'parallel')
missing <- required_pkgs[!sapply(required_pkgs, requireNamespace, quietly=TRUE)]
if (length(missing) > 0) {
  cat('Missing packages:', paste(missing, collapse=', '), '\n')
} else {
  cat('✓ All R packages installed.\n')
}

# Test Julia
library(JuliaCall)
tryCatch({
  julia_setup()
  cat('✓ Julia connection successful.\n')
  cat('  Julia version:', julia_eval('string(VERSION)'), '\n')
}, error = function(e) {
  cat('✗ Julia connection failed:', e$message, '\n')
})
"
```

## 预期总运行时间

| Phase | 时间 | 说明 |
|-------|------|------|
| 1. 环境设置 | 2分钟 | 一次性设置 |
| 2. 数据获取 | 5分钟 | 需要API密钥 |
| 3. 数据转换 | 1分钟 | 使用Julia加速 |
| 4. BVAR测试 | 3分钟 | 验证设置 |
| 5. 递归预测 | 35-60分钟 | **最耗时** |
| 6. 预测评估 | 5分钟 | |
| 7. CG回归 | 3分钟 | |
| **总计** | **55-80分钟** | |

## 输出文件结构

```
results/
├── forecasts/
│   ├── small_model_forecasts.rds        # 小模型预测
│   ├── medium_model_forecasts.rds       # 中模型预测
│   ├── full_model_forecasts.rds         # 完整模型预测
│   ├── aligned_forecasts_actuals.rds    # 预测与实际对齐数据
│   ├── hyperparameters_evolution.csv    # 超参数演化
│   └── checkpoints/                     # 检查点（可删除）
├── tables/
│   ├── rmsfe_results.csv                # RMSFE结果（用于论文）
│   ├── relative_rmsfe.csv               # 相对表现（vs RW）
│   ├── relative_rmsfe_vs_ar1.csv        # 相对表现（vs AR1）
│   ├── dm_test_results.csv              # DM检验结果
│   ├── dm_model_comparison.csv          # 模型间比较
│   ├── cg_regression_results.csv        # CG回归系数（关键结果）
│   ├── delta_beta_overreaction_test.csv # 过度反应检验
│   ├── error_decomposition.csv          # 误差分解
│   └── rolling_rmsfe.csv                # 滚动RMSFE
├── figures/
│   ├── fig_error_decomposition.png      # 误差分解图
│   └── fig_rolling_relative_rmsfe_*.png # 滚动相对RMSFE图
├── robustness/
│   ├── lag6/                            # 6期滞后稳健性
│   └── window1995/                      # 1995初始窗口稳健性
└── diagnostics/
    ├── test_bvar_fit.rds
    └── test_hyperparameters.csv
```

## 下一步

1. **查看结果:**
   ```bash
   # 用Excel打开
   start results\tables\cg_regression_results.csv
   ```

2. **集成到论文:**
   - 将 `results/tables/*.csv` 导入LaTeX
   - 使用 `ForecastingHorseRace.tex` 撰写分析

3. **可选: 创建可视化**
   - 实现 `code/08_visualization.R` （计划中）
   - 生成时间序列图、散点图等

---

**如有问题，请参考:**
- `README.md` - 详细文档
- `implementation_plan.md` - 技术细节
- R脚本注释 - 代码级文档
