---
title: "Applied Work"
author: "Hong Wei"
date: "2025-11-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

## c
```{r question c}
rm(list=ls())
library(tidyverse)
library(haven)
library(knitr)
library(ggplot2)
library(fixest)


## 1. Read the raw data ----------------------------------------------------
dots <- read_dta("dots1960_2005.dta") %>%
  rename(
    trade = flow_dots,  
    exporter = iso_o,
    importer = iso_d
  )

pwt <- read_dta("pwt.dta")
pwt_o <- pwt %>%
  rename(
    exporter = iso3,
    gdp_o    = cgdp,
    pop_o    = pop,
    pc_o     = pc
  )
pwt_d <- pwt %>%
  rename(
    importer = iso3,
    gdp_d    = cgdp,
    pop_d    = pop,
    pc_d     = pc
  )

dist_cepii <- read_dta("dist_cepii.dta") %>%
  rename(
    exporter     = iso_o,
    importer     = iso_d,
    same_country = smctry
  )

rta <- read_dta("RTA.dta") %>%
  rename(
    exporter = iso_o,
    importer = iso_d,
  )

cu <- read_dta("CU.dta") %>%
  rename(
    exporter = iso_o,
    importer = iso_d,
    cu       = comcur
  )

## 2. Construct the gravity dataset ----------------------------------------
gravity <- dots %>%
  left_join(pwt_o, by = c("exporter", "year")) %>%
  left_join(pwt_d, by = c("importer", "year")) %>%
  left_join(dist_cepii, by = c("exporter", "importer")) %>%
  left_join(rta, by = c("exporter", "importer", "year")) %>%
  left_join(cu, by = c("exporter", "importer", "year")) %>%
  mutate(
    ln_trade = log(trade),
    ln_gdp_o = log(gdp_o),
    ln_gdp_d = log(gdp_d),
    ln_pop_o = log(pop_o),
    ln_pop_d = log(pop_d)
  )

## 3. Summarize the data ---------------------------------------------------
summary_stats <- gravity %>%
  summarise(
    n_unique_exporters = n_distinct(exporter),
    n_unique_importers = n_distinct(importer),
    n_unique_countries = n_distinct(exporter, importer),
    n_years            = n_distinct(year),
    min_year           = min(year, na.rm = TRUE),
    max_year           = max(year, na.rm = TRUE)
  )


kable(
  summary_stats,
  format  = "latex",
  booktabs = TRUE,
  caption = "Summary statistics: countries and years in the gravity sample."
)

vars_for_desc <- gravity %>%
  select(trade, gdp_o, gdp_d, pop_o, pop_d, pc_o, pc_d, dist, rta, cu)

desc_table <- vars_for_desc %>%
  summarise(
    across(
      .cols = everything(),
      .fns = list(
        mean = ~mean(., na.rm = TRUE),
        sd   = ~sd(., na.rm = TRUE),
        min  = ~min(., na.rm = TRUE),
        max  = ~max(., na.rm = TRUE)
      ),
      .names = "{.col}__{.fn}"
    )
  ) %>%
  pivot_longer(
    cols = everything(),
    names_to = c("variable", "stat"),
    names_sep = "__",
    values_to = "value"
  ) %>%
  pivot_wider(
    names_from = stat,
    values_from = value
  ) %>% 
  rename(Variable = variable, Mean = mean, Std = sd, Min = min, Max = max)

kable(
  desc_table,
  format   = "latex",
  booktabs = TRUE,
  digits   = 3,  
  caption  = "Descriptive statistics for key gravity variables.",
  format.args = list(
    big.mark   = ",",  
    scientific = FALSE  
  )
)
```

## d
```{r question d}
## 4. Plot the trend ----------------------------------------------------
gravity <- gravity %>%
  mutate(
    rta = as.integer(rta),
    cu  = as.integer(cu)
  )

shares_trade <- gravity %>%
  group_by(year) %>%
  summarise(
    total_trade   = sum(trade, na.rm = TRUE),
    trade_RTA     = sum(trade * (rta == 1), na.rm = TRUE),
    trade_CU      = sum(trade * (cu  == 1), na.rm = TRUE)
  ) %>%
  mutate(
    share_trade_RTA = trade_RTA / total_trade,
    share_trade_CU  = trade_CU  / total_trade
  )

kable(
  shares_trade,
  format  = "latex",
  booktabs = TRUE,
  digits  = 3,
  caption = "Evolution of the share of world trade within RTAs and currency unions",
  format.args = list(
    big.mark   = ",",  
    scientific = FALSE  
  )
)

shares_trade_long <- shares_trade %>%
  select(year, share_trade_RTA, share_trade_CU) %>%
  pivot_longer(
    cols      = -year,
    names_to  = "type",
    values_to = "share"
  ) %>%
  mutate(type = case_match(type, 
                           "share_trade_RTA" ~ "RTA Share", 
                           "share_trade_CU" ~ "CU Share"))

ggplot(shares_trade_long, aes(x = year, y = share, color = type)) +
  geom_line() +
  geom_point() +
  labs(
    x = "Year",
    y = "Share of total trade",
    color = "",
    title = "Share of world trade within RTAs and CUs over time"
  ) +
  theme_minimal()

shares_pairs <- gravity %>%
  group_by(year) %>%
  summarise(
    total_pairs = n_distinct(paste(exporter, importer, sep = "_")),
    rta_pairs   = n_distinct(paste(exporter[rta == 1],
                                   importer[rta == 1],
                                   sep = "_")),
    cu_pairs    = n_distinct(paste(exporter[cu == 1],
                                   importer[cu == 1],
                                   sep = "_"))
  ) %>%
  mutate(
    share_pairs_RTA = rta_pairs / total_pairs,
    share_pairs_CU  = cu_pairs  / total_pairs
  )

kable(
  shares_pairs,
  format  = "latex",
  booktabs = TRUE,
  digits  = 3,
  caption = "Evolution of the share of country pairs in RTAs and currency unions."
)

shares_pairs_long <- shares_pairs %>%
  select(year, share_pairs_RTA, share_pairs_CU) %>%
  pivot_longer(
    cols      = -year,
    names_to  = "type",
    values_to = "share"
  )%>%
  mutate(type = case_match(type, 
                           "share_pairs_RTA" ~ "RTA Share", 
                           "share_pairs_CU" ~ "CU Share"))



plot_trade <- ggplot(shares_trade_long, aes(x = year, y = share, color = type)) +
  geom_line() +
  geom_point() +
  labs(
    x = "Year",
    y = "Share of total trade",
    color = "", 
    title = "Share of world trade within RTAs and CUs over time"
  ) +
  scale_color_manual(values = c("RTA Share" = "blue", "CU Share" = "red")) + 
  theme_minimal() +
  theme(legend.position = "bottom") # 

ggsave(
  filename = "world_trade_shares.png",
  plot = plot_trade,
  width = 8,  
  height = 5, 
  dpi = 600   
)

plot_pairs <- ggplot(shares_pairs_long, aes(x = year, y = share, color = type)) +
  geom_line() +
  geom_point() +
  labs(
    x = "Year",
    y = "Share of country pairs",
    color = "",
    title = "Share of country pairs in RTAs and CUs over time"
  ) +
  scale_color_manual(values = c("RTA Share" = "blue", "CU Share" = "red")) +
  theme_minimal() +
  theme(legend.position = "bottom")

ggsave(
  filename = "country_pairs_shares.png",
  plot = plot_pairs,
  width = 8,
  height = 5, 
  dpi = 600   
)
```

## e
```{r question e}
## 5. Regression under 4 specifications -----------------------------
gravity <- gravity %>%
  mutate(
    ln_trade = log(trade),
    ln_gdp_o = log(gdp_o),
    ln_gdp_d = log(gdp_d),
    ln_distw = log(distw),    # choose weighted distance here
    pair_id  = interaction(exporter, importer, drop = TRUE)   # country-pair identifier for clustering
  )

## 5.1. traditional gravity, GDPs and distance -----------------
mod_e1 <- feols(
  ln_trade ~ ln_gdp_o + ln_gdp_d + ln_distw + i(year),
  data    = gravity,
  cluster = ~ pair_id
)

## 5.2. add CU and RTA dummies --------------------------------
mod_e2 <- feols(
  ln_trade ~ ln_gdp_o + ln_gdp_d + ln_distw + cu + rta + i(year),
  data    = gravity,
  cluster = ~ pair_id
)

## 5.3. add other trade-cost proxies ---------------------------
mod_e3 <- feols(
  ln_trade ~ ln_gdp_o + ln_gdp_d + ln_distw +
    contig + comlang_off + colony + curcol + same_country +
    cu + rta + i(year),
  data    = gravity,
  cluster = ~ pair_id
)

## 5.4. importer and exporter fixed effects --------------------
mod_e4 <- feols(
  ln_trade ~ ln_gdp_o + ln_gdp_d + ln_distw +
    contig + comlang_off + colony + curcol + same_country +
    cu + rta +
    i(year) | exporter + importer,
  data    = gravity,
  cluster = ~ pair_id
)

etable(
  mod_e1, mod_e2, mod_e3, mod_e4,
  dict = c(
    "ln_trade"   = "Log trade",
    "ln_gdp_o"   = "Log GDP (exporter)",
    "ln_gdp_d"   = "Log GDP (importer)",
    "ln_distw"   = "Log distance",
    "cu"         = "Currency union",
    "rta"        = "Regional trade agreement",
    "contig"     = "Contiguous",
    "comlang_off"= "Common official language",
    "colony"     = "Ever colony",
    "curcol"     = "Current colony",
    "same_country" = "Same country"
  ),
  group = list("Year Fixed Effects" = "year"),
  se.below = TRUE,
  fitstat  = c("n", "r2"),
  tex      = TRUE,
  style.tex = style.tex("aer"),
  title    = "Currency union effects on trade: alternative gravity specifications"
)
```

## h
```{r question h}
## 6. Run regressions for each year:
mod_h <- feols(
  ln_trade ~ ln_distw + contig + comlang_off + colony + curcol 
  + same_country + cu + rta | exporter + importer,
  data    = gravity,
  split   = ~ year,    #split by year
  cluster = ~ pair_id 
)

etable(
  mod_h,
  dict    = c(
    "ln_distw"      = "Log distance",
    "contig"        = "Contiguous",
    "comlang_off"   = "Common official language",
    "colony"        = "Ever colony",
    "curcol"        = "Current colony",
    "same_country"  = "Same country",
    "cu"            = "Currency union",
    "rta"           = "Regional trade agreement"
  ),
  se.below = TRUE,
  fitstat  = c("n", "r2"),
  tex      = TRUE,
  style.tex = style.tex(model.format = "wait"), 
  postprocess.tex = function(x) {
    x <- gsub("\\\\begin\\{tabular\\}", "\\\\resizebox{\\\\textwidth}{!}{\\\\begin{tabular}", x)
    x <- gsub("\\\\end\\{tabular\\}", "\\\\end{tabular}}", x)
    return(x)
  },
  title    = "Year-by-Year Gravity with Country FEs"
)


coef_h <- coeftable(mod_h, keep = c("cu", "rta")) %>%
  as.data.frame() %>%
  filter(coefficient %in% c("cu", "rta")) %>%
  transmute(
    year     = as.numeric(sample),   
    variable = coefficient,         
    estimate = Estimate,
    std.error = `Std. Error`
  )

cu_path <- coef_h %>%
  filter(variable == "cu")

p <- ggplot(cu_path, aes(x = year, y = estimate)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray40", linewidth = 0.8) +
  geom_errorbar(
    aes(ymin = estimate - 1.96 * std.error, 
        ymax = estimate + 1.96 * std.error),
    width = 0.2,       
    color = "gray30",  
    alpha = 0.8
  ) +

  geom_line(color = "black", linewidth = 0.8) +
  geom_point(size = 3, shape = 21, fill = "white", color = "black") + 

  scale_x_continuous(
    breaks = seq(min(cu_path$year, na.rm=TRUE), max(cu_path$year, na.rm=TRUE), by = 5) 
  ) +
  labs(
    x = "Year",
    y = "Estimated Coefficient (Currency Union)",
    caption = "Note: Point estimates with 95% confidence intervals"
  ) +
  
  theme_classic(base_size = 14) + 
  theme(
    plot.title = element_text(face = "bold", size = 16, hjust = 0.5), 
    plot.subtitle = element_text(size = 12, color = "gray40", hjust = 0.5),
    axis.text = element_text(color = "black"),
    panel.grid.major.y = element_line(color = "gray90", linewidth = 0.5), 
    axis.line = element_line(linewidth = 0.8) 
  )
ggsave("cu_effect_over_time.png", plot = p, width = 8, height = 5, dpi = 600)
```


## i
```{r question i}
## 7. Run regressions with dyadic FE -----------------------------
mod_i <- feols(
  ln_trade ~ cu + rta | year + pair_id,
  data    = gravity,
  cluster = ~ pair_id
)

etable(
  mod_i,
  dict    = c(
    "cu"            = "Currency union",
    "rta"           = "Regional trade agreement"
  ),
  se.below = TRUE,
  fitstat  = c("n", "r2"),
  tex      = TRUE,
  style.tex = style.tex("aer"),
  title    = "Gravity regressions with country-pair FE"
)
```

## j
```{r question j}
## 8. Run regressions with high-dimension FE -----------------------------
gravity <- gravity %>%
  mutate(
    exp_year = interaction(exporter, year,     drop = TRUE),  # exporter × year FE
    imp_year = interaction(importer, year,     drop = TRUE)   # importer × year FE
  )

mod_j1 <- feols(
  ln_trade ~ ln_distw + contig + comlang_off + colony 
  + curcol + same_country + cu + rta | exp_year + imp_year,
  data    = gravity,
  cluster = ~ pair_id
)

mod_j2 <- feols(
  ln_trade ~ cu + rta | exp_year + imp_year + pair_id,
  data    = gravity,
  cluster = ~ pair_id
)

etable(
  mod_j1, mod_j2,
  dict    = c(
    "ln_distw"      = "Log distance",
    "contig"        = "Contiguous",
    "comlang_off"   = "Common official language",
    "colony"        = "Ever colony",
    "curcol"        = "Current colony",
    "same_country"  = "Same country",
    "cu"            = "Currency union",
    "rta"           = "Regional trade agreement"
  ),
  se.below = TRUE,
  fitstat  = c("n", "r2"),
  tex      = TRUE,
  style.tex = style.tex("aer"),
  title    = "Gravity regressions with high-dimension FE"
)
```



## k
```{r question k}
## 9. Country Size Heterogeneity Analysis -----------------------------
gravity <- gravity %>%
  mutate(
    ln_gdp_avg = (ln_gdp_o + ln_gdp_d) / 2
  )

mod_k1 <- feols(
  ln_trade ~ ln_distw + contig + comlang_off + colony 
  + curcol + same_country + cu + rta + cu:ln_gdp_avg | exp_year + imp_year, 
  data    = gravity,
  cluster = ~ pair_id
)

mod_k2 <- feols(
  ln_trade ~ cu + rta + cu:ln_gdp_avg | exp_year + imp_year + pair_id, 
  data    = gravity,
  cluster = ~ pair_id
)


etable(
  mod_k1, mod_k2,
  dict    = c(
    "ln_distw"      = "Log distance",
    "contig"        = "Contiguous",
    "comlang_off"   = "Common official language",
    "colony"        = "Ever colony",
    "curcol"        = "Current colony",
    "same_country"  = "Same country",
    "cu"            = "Currency union",
    "rta"           = "Regional trade agreement"
  ),
  se.below = TRUE,
  fitstat  = c("n", "r2"),
  tex      = TRUE,
  style.tex = style.tex("aer"),
  title    = "Heterogeneity Analysis"
)
```


## l
```{r question l}
## 10. PPML Estimation -----------------------------
mod_l <- fepois(
  trade ~ cu + rta | pair_id + year,
  data    = gravity,
  cluster = ~ pair_id
)

etable(
  mod_l,
  dict    = c(
    "ln_distw"      = "Log distance",
    "contig"        = "Contiguous",
    "comlang_off"   = "Common official language",
    "colony"        = "Ever colony",
    "curcol"        = "Current colony",
    "same_country"  = "Same country",
    "cu"            = "Currency union",
    "rta"           = "Regional trade agreement"
  ),
  se.below = TRUE,
  fitstat  = c("n", "pr2"),
  tex      = TRUE,
  style.tex = style.tex("aer"),
  title    = "PPML gravity with country-pair and year fixed effects"
)
```


## m
```{r question m}
## 11. The Effect of the Euro ----------------------------------
euro11 <- c("AUT", "BEL", "FIN", "FRA", "DEU", "IRL", "ITA", "LUX", "NLD", "PRT", "ESP") # Initial Euro Zone countries when created

gravity <- gravity %>%
  mutate(
    euro_o = (exporter %in% euro11 & year >= 1999) | (exporter == "GRC" & year >= 2001),
    euro_d = (importer %in% euro11 & year >= 1999) | (importer == "GRC" & year >= 2001),
    euro = ifelse(euro_o & euro_d, 1, 0),
    other_cu = ifelse(cu == 1 & euro == 0, 1, 0)
  )

mod_m_ppml <- fepois(
  trade ~ euro + other_cu + rta | pair_id + year,
  data    = gravity,
  cluster = ~ pair_id
)


etable(
  mod_m_ppml,
  dict    = c(
    "euro"          = "Euro Zone",
    "other_cu"      = "Other currency union",
    "rta"           = "Regional trade agreement"
  ),
  se.below = TRUE,
  fitstat = c("n", "r2","pr2"),
  tex      = TRUE,
  style.tex = style.tex("aer"),
  title = "The Effect of the Euro on Trade"
)
```